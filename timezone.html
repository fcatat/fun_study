<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸–ç•Œæ—¶é—´æ¢ç´¢</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zcool+KuaiLe&display=swap');

        :root {
            --bg-color: #0A1929;
        }

        body {
            margin: 0;
            padding: 0;
            background: radial-gradient(circle at 10% 20%, #283593 0%, #000000 100%);
            font-family: "Zcool KuaiLe", "Comic Sans MS", cursive, sans-serif;
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
            user-select: none;
            touch-action: none;
            color: white;
        }

        .btn-home {
            position: absolute;
            top: 15px;
            left: 15px;
            background: white;
            border: 2px solid #1976D2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            cursor: pointer;
            text-decoration: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 100;
        }

        header {
            padding: 10px;
            text-align: center;
            width: 100%;
            position: absolute;
            top: 0;
            pointer-events: none;
        }

        h1 {
            margin: 0;
            color: #FFD700;
            font-size: 1.6rem;
            text-shadow: 0 0 10px rgba(255,215,0,0.5);
        }

        .sun-container {
            position: absolute;
            top: 60px;
            left: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: none;
            z-index: 10;
        }

        .sun {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #FFF59D, #FFD700);
            box-shadow: 0 0 60px rgba(255, 215, 0, 0.6), 0 0 120px rgba(255, 215, 0, 0.3);
            animation: sunGlow 3s ease-in-out infinite;
        }

        @keyframes sunGlow {
            0%, 100% { transform: scale(1); box-shadow: 0 0 60px rgba(255, 215, 0, 0.6); }
            50% { transform: scale(1.05); box-shadow: 0 0 80px rgba(255, 215, 0, 0.8); }
        }

        .sun-label {
            margin-top: 10px;
            font-size: 1.2rem;
            color: #FFD700;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .game-area {
            flex: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            position: relative;
        }

        .earth-container {
            width: 600px;
            height: 600px;
            position: relative;
            cursor: grab;
            touch-action: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .earth-container:active {
            cursor: grabbing;
        }

        #earth-svg {
            border-radius: 50%;
            box-shadow: 0 0 40px rgba(74, 144, 226, 0.5);
            overflow: hidden;
        }

        .ocean {
            fill: url(#oceanGradient);
        }

        .land {
            fill: #4CAF50;
            stroke: #388E3C;
            stroke-width: 0.5;
        }

        .graticule {
            fill: none;
            stroke: rgba(255,255,255,0.2);
            stroke-width: 0.5;
        }

        .city-marker {
            position: absolute;
            background: rgba(255,255,255,0.95);
            color: #1565C0;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(0,0,0,0.5);
            transform: translate(-50%, -50%);
            pointer-events: none;
            white-space: nowrap;
            border: 2px solid #1976D2;
        }
        
        .city-marker::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 8px 6px 0;
            border-style: solid;
            border-color: #1976D2 transparent transparent transparent;
        }

        .cities-info {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 800px;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            padding-bottom: env(safe-area-inset-bottom, 15px);
            max-height: 180px;
            overflow-y: auto;
            z-index: 20;
        }

        .city-info-card {
            background: white;
            border-radius: 12px;
            padding: 8px 5px;
            text-align: center;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .city-info-card.day {
            background: #FFF9C4;
            border-color: #FFD700;
            color: #3E2723;
        }

        .city-info-card.night {
            background: #1A237E;
            color: #FFF;
            border-color: #3F51B5;
        }

        .city-info-name {
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .city-info-time {
            font-size: 1.1rem;
            font-weight: 900;
        }

        .instruction {
            position: absolute;
            top: 100px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 50;
            max-width: 200px;
            text-align: center;
        }

        @media (max-width: 800px) {
            .game-area {
                flex-direction: column;
            }
            .sun-container {
                position: relative;
                top: auto;
                left: auto;
                margin-bottom: -50px; 
                transform: scale(0.8);
                z-index: 5;
            }
            .earth-container {
                width: 400px;
                height: 400px;
            }
            .cities-info {
                max-height: 160px;
                grid-template-columns: repeat(4, 1fr);
            }
            .instruction {
                top: 60px;
                right: auto;
                left: 50%;
                transform: translateX(-50%);
                width: 80%;
            }
        }
    </style>
</head>
<body>

<a href="index.html" class="btn-home">ğŸ </a>

<header>
    <h1>ğŸŒ æˆ‘ä»¬çš„åœ°çƒæ—¶é—´</h1>
</header>

<div class="instruction" id="instruction">ğŸ‘‰ å·¦å³æ‹–åŠ¨åœ°çƒ<br>çœ‹çœ‹è°åœ¨ç™½å¤©ï¼Œè°åœ¨é»‘å¤œ</div>

<div class="game-area">
    <div class="earth-container" id="earth-container">
        <svg id="earth-svg" width="560" height="560"></svg>
    </div>
</div>

<div class="cities-info" id="cities-info"></div>

<script>
    const CITIES = [
        { name: 'å¤å¨å¤·', timezone: -10, lat: 21.3, lng: -157.8 },
        { name: 'æ´›æ‰çŸ¶', timezone: -8, lat: 34.0, lng: -118.2 },
        { name: 'çº½çº¦', timezone: -5, lat: 40.7, lng: -74.0 },
        { name: 'é‡Œçº¦', timezone: -3, lat: -22.9, lng: -43.2 },
        { name: 'ä¼¦æ•¦', timezone: 0, lat: 51.5, lng: -0.1 },
        { name: 'å·´é»', timezone: 1, lat: 48.9, lng: 2.3 },
        { name: 'å¼€ç½—', timezone: 2, lat: 30.0, lng: 31.2 },
        { name: 'è«æ–¯ç§‘', timezone: 3, lat: 55.8, lng: 37.6 },
        { name: 'è¿ªæ‹œ', timezone: 4, lat: 25.2, lng: 55.3 },
        { name: 'å˜‰å³ªå…³', timezone: 8, lat: 39.8, lng: 98.3 }, 
        { name: 'æ•¦ç…Œ', timezone: 8, lat: 40.1, lng: 94.6 },
        { name: 'åŒ—äº¬', timezone: 8, lat: 39.9, lng: 116.4 },
        { name: 'ä¸Šæµ·', timezone: 8, lat: 31.2, lng: 121.5 },
        { name: 'ä¸œäº¬', timezone: 9, lat: 35.7, lng: 139.7 },
        { name: 'æ‚‰å°¼', timezone: 10, lat: -33.9, lng: 151.2 }
    ];

    // ==========================================
    // ç®€åŒ–è®¾è®¡ï¼šå¤ªé˜³å›ºå®šåœ¨å·¦ä¾§ï¼Œåœ°çƒå¯ä»¥æ—‹è½¬
    // ==========================================
    // rotateY è¡¨ç¤ºåœ°çƒæ—‹è½¬è§’åº¦ï¼ˆæ§åˆ¶æˆ‘ä»¬çœ‹åˆ°çš„è§†è§’ï¼‰
    // å¤ªé˜³å§‹ç»ˆåœ¨å·¦ä¾§ç…§å°„ï¼Œæ™¨æ˜çº¿å›ºå®šåœ¨åœ°çƒä¸­å¤®
    
    let rotateY = 0; // åœ°çƒæ—‹è½¬è§’åº¦
    let baseHour = 15; // åŸºå‡†æ—¶é—´ï¼šåŒ—äº¬ä¸‹åˆ3ç‚¹
    let isDragging = false;
    let startX = 0;
    let startRotateY = 0;
    let worldData = null;

    const width = 560;
    const height = 560;
    const radius = 270;

    // D3 æ­£äº¤æŠ•å½±
    const projection = d3.geoOrthographic()
        .scale(radius)
        .translate([width / 2, height / 2])
        .clipAngle(90)
        .rotate([0, 0, 0]);

    const path = d3.geoPath().projection(projection);
    const graticule = d3.geoGraticule().step([30, 30]);

    const svg = d3.select("#earth-svg");
    const defs = svg.append("defs");
    
    // æµ·æ´‹æ¸å˜
    const oceanGradient = defs.append("radialGradient")
        .attr("id", "oceanGradient")
        .attr("cx", "30%")
        .attr("cy", "30%");
    oceanGradient.append("stop").attr("offset", "0%").attr("stop-color", "#42A5F5");
    oceanGradient.append("stop").attr("offset", "100%").attr("stop-color", "#0D47A1");

    // å…‰ç…§é˜´å½±æ¸å˜ - å›ºå®šä»å·¦åˆ°å³å˜æš—ï¼ˆå¤ªé˜³åœ¨å·¦ä¾§ï¼‰
    const shadowGradient = defs.append("linearGradient")
        .attr("id", "shadowGradient")
        .attr("x1", "0%").attr("y1", "50%")
        .attr("x2", "100%").attr("y2", "50%");
    shadowGradient.append("stop").attr("offset", "0%").attr("stop-color", "rgba(0,0,0,0)");
    shadowGradient.append("stop").attr("offset", "30%").attr("stop-color", "rgba(0,0,0,0)");
    shadowGradient.append("stop").attr("offset", "45%").attr("stop-color", "rgba(0,0,0,0.15)");
    shadowGradient.append("stop").attr("offset", "50%").attr("stop-color", "rgba(0,0,0,0.5)");
    shadowGradient.append("stop").attr("offset", "55%").attr("stop-color", "rgba(0,0,0,0.85)");
    shadowGradient.append("stop").attr("offset", "100%").attr("stop-color", "rgba(0,0,0,0.95)");

    // é«˜å…‰æ¸å˜
    const highlightGradient = defs.append("radialGradient")
        .attr("id", "highlightGradient")
        .attr("cx", "25%")
        .attr("cy", "25%");
    highlightGradient.append("stop").attr("offset", "0%").attr("stop-color", "rgba(255,255,255,0.4)");
    highlightGradient.append("stop").attr("offset", "100%").attr("stop-color", "rgba(255,255,255,0)");

    // åœ°çƒå„å±‚
    const globeGroup = svg.append("g");
    
    // æµ·æ´‹
    globeGroup.append("circle")
        .attr("cx", width / 2)
        .attr("cy", height / 2)
        .attr("r", radius)
        .attr("class", "ocean");

    // é™†åœ°
    const landGroup = globeGroup.append("g").attr("class", "land-group");
    
    // ç»çº¬çº¿
    const graticuleGroup = globeGroup.append("g").attr("class", "graticule-group");
    graticuleGroup.append("path")
        .datum(graticule)
        .attr("class", "graticule")
        .attr("d", path);


    // é«˜å…‰å±‚
    globeGroup.append("circle")
        .attr("cx", width / 2)
        .attr("cy", height / 2)
        .attr("r", radius)
        .attr("fill", "url(#highlightGradient)")
        .style("pointer-events", "none");

    // è¾¹ç¼˜
    globeGroup.append("circle")
        .attr("cx", width / 2)
        .attr("cy", height / 2)
        .attr("r", radius)
        .attr("fill", "none")
        .attr("stroke", "rgba(100, 181, 246, 0.6)")
        .attr("stroke-width", 2);

    // åŠ è½½ä¸–ç•Œåœ°å›¾æ•°æ®
    async function loadWorld() {
        try {
            const response = await fetch("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json");
            const world = await response.json();
            worldData = topojson.feature(world, world.objects.countries);
            renderLand();
        } catch (e) {
            console.error("Failed to load world data:", e);
            useFallbackLand();
        }
    }

    function renderLand() {
        landGroup.selectAll("path").remove();
        landGroup.selectAll("path")
            .data(worldData.features)
            .enter()
            .append("path")
            .attr("class", "land")
            .attr("d", path);
    }

    function useFallbackLand() {
        const simpleLand = {
            type: "FeatureCollection",
            features: [
                { type: "Feature", geometry: { type: "Polygon", coordinates: [[[-168,70],[-120,60],[-80,60],[-60,50],[-80,30],[-100,20],[-120,30],[-130,50],[-168,70]]] }},
                { type: "Feature", geometry: { type: "Polygon", coordinates: [[[-80,10],[-35,-5],[-40,-20],[-55,-35],[-70,-55],[-75,-20],[-80,10]]] }},
                { type: "Feature", geometry: { type: "Polygon", coordinates: [[[-10,35],[10,35],[30,40],[60,60],[140,70],[170,60],[150,40],[120,30],[110,10],[80,10],[60,25],[40,30],[10,40],[-10,35]]] }},
                { type: "Feature", geometry: { type: "Polygon", coordinates: [[[-15,35],[30,30],[50,10],[40,-15],[20,-35],[10,-10],[-15,10],[-15,35]]] }},
                { type: "Feature", geometry: { type: "Polygon", coordinates: [[[110,-20],[150,-10],[155,-30],[130,-35],[110,-20]]] }}
            ]
        };
        worldData = simpleLand;
        renderLand();
    }

    // ==========================================
    // ç®€åŒ–å‡½æ•°ï¼šè®¡ç®—åŸå¸‚æ—¶é—´
    // ==========================================
    function getCityTime(city) {
        // åœ°çƒæ—‹è½¬å¸¦æ¥çš„æ—¶é—´åç§»ï¼šæ¯15åº¦ = 1å°æ—¶
        const rotationHours = -rotateY / 15;
        // æ—¶åŒºå·®
        const timezoneOffset = city.timezone - 8; // ç›¸å¯¹äºåŒ—äº¬ï¼ˆUTC+8ï¼‰
        
        let totalHours = baseHour + timezoneOffset + rotationHours;
        
        // å½’ä¸€åŒ–åˆ° 0-24
        while (totalHours < 0) totalHours += 24;
        while (totalHours >= 24) totalHours -= 24;
        
        const hour = Math.floor(totalHours);
        const minute = Math.floor((totalHours - hour) * 60);
        
        return { hour, minute };
    }

    function updateProjection() {
        projection.rotate([rotateY, 0, 0]);
        landGroup.selectAll("path").attr("d", path);
        graticuleGroup.select("path").attr("d", path);
    }

    function renderCityMarkers() {
        const container = document.getElementById('earth-container');
        const oldMarkers = container.querySelectorAll('.city-marker');
        oldMarkers.forEach(m => m.remove());
        
        CITIES.forEach((city) => {
            const coords = projection([city.lng, city.lat]);
            if (!coords) return;
            
            const distance = d3.geoDistance([city.lng, city.lat], [-rotateY, 0]);
            if (distance > Math.PI / 2) return;
            
            const marker = document.createElement('div');
            marker.className = 'city-marker';
            marker.innerText = city.name;
            
            const opacity = Math.max(0.5, 1 - (distance / (Math.PI / 2)) * 0.5);
            marker.style.opacity = opacity;
            
            const offsetX = (600 - 560) / 2;
            const offsetY = (600 - 560) / 2;
            marker.style.left = (coords[0] + offsetX) + 'px';
            marker.style.top = (coords[1] + offsetY) + 'px';
            
            container.appendChild(marker);
        });
    }

    function renderCitiesInfo() {
        const infoPanel = document.getElementById('cities-info');
        infoPanel.innerHTML = '';
        
        CITIES.forEach((city) => {
            const time = getCityTime(city);
            
            // åˆ¤æ–­ç™½å¤©/å¤œæ™šï¼šåŸºäºåŸå¸‚åœ¨å±å¹•ä¸Šçš„ä½ç½®
            // å¤ªé˜³åœ¨å·¦ä¾§ï¼Œæ™¨æ˜çº¿åœ¨åœ°çƒä¸­å¤®ï¼ˆx = width/2ï¼‰
            // å¦‚æœåŸå¸‚çš„å±å¹• X åæ ‡ < ä¸­å¿ƒï¼Œå°±æ˜¯ç™½å¤©ï¼›å¦åˆ™æ˜¯é»‘å¤œ
            const coords = projection([city.lng, city.lat]);
            let isDay = false;
            
            if (coords) {
                // åŸå¸‚åœ¨æ­£é¢å¯è§
                isDay = coords[0] < width / 2; // åœ¨å·¦åŠè¾¹ = ç™½å¤©
            } else {
                // åŸå¸‚åœ¨èƒŒé¢ï¼Œæ ¹æ®ç»åº¦åˆ¤æ–­
                let lngDiff = city.lng - (-rotateY);
                while (lngDiff > 180) lngDiff -= 360;
                while (lngDiff < -180) lngDiff += 360;
                // ç®€åŒ–ï¼šå¦‚æœç»åº¦å·®åœ¨ -90 åˆ° 0 ä¹‹é—´ï¼Œç®—ç™½å¤©
                isDay = lngDiff >= -90 && lngDiff < 0;
            }
            
            const div = document.createElement('div');
            div.className = `city-info-card ${isDay ? 'day' : 'night'}`;
            div.innerHTML = `
                <div class="city-info-name">${city.name}</div>
                <div class="city-info-time">${pad(time.hour)}:${pad(time.minute)}</div>
            `;
            infoPanel.appendChild(div);
        });
    }

    function pad(n) { return n < 10 ? '0' + n : n; }

    function initDrag() {
        const el = document.getElementById('earth-container');

        function start(e) {
            e.preventDefault();
            isDragging = true;
            startX = e.touches ? e.touches[0].clientX : e.clientX;
            startRotateY = rotateY;
            document.getElementById('instruction').style.display = 'none';
        }

        function move(e) {
            if (!isDragging) return;
            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const delta = x - startX;
            rotateY = startRotateY + delta * 0.3;
            
            updateProjection();
            renderCityMarkers();
            renderCitiesInfo();
        }

        function end() { isDragging = false; }

        el.addEventListener('mousedown', start);
        window.addEventListener('mousemove', move);
        window.addEventListener('mouseup', end);
        el.addEventListener('touchstart', start, { passive: false });
        window.addEventListener('touchmove', move, { passive: false });
        window.addEventListener('touchend', end);
    }

    // åˆå§‹åŒ–
    async function init() {
        await loadWorld();
        updateProjection();
        renderCityMarkers();
        renderCitiesInfo();
        initDrag();
    }

    init();
</script>
</body>
</html>
