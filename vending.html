<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŠ¨ç‰©å”®è´§æœº (è®¤è¯†è´§å¸)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zcool+KuaiLe&display=swap');

        :root {
            --bg-color: #F3E5F5;
            --machine-color: #FF8A65;
            --machine-dark: #D84315;
            --screen-bg: #263238;
            --screen-text: #76FF03;
            --coin-1yuan: #ECEFF1;
            --coin-5jiao: #FFD54F;
            --coin-1jiao: #CFD8DC;
        }

        body {
            margin: 0;
            padding: 0;
            background: var(--bg-color);
            font-family: "Zcool KuaiLe", "Comic Sans MS", cursive, sans-serif;
            height: 100vh;
            height: 100dvh; /* åŠ¨æ€é«˜åº¦ */
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
            user-select: none;
            touch-action: none;
        }

        /* è¿”å›æŒ‰é’® */
        .btn-home {
            position: absolute;
            top: 15px;
            left: 15px;
            background: white;
            border: 2px solid var(--machine-dark);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            cursor: pointer;
            text-decoration: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 100;
        }

        header {
            padding: 15px;
            text-align: center;
        }

        h1 {
            margin: 0;
            color: #880E4F;
            font-size: 1.8rem;
        }

        .level-info {
            background: white;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 5px;
            color: #880E4F;
            font-size: 1.2rem;
        }

        /* å”®è´§æœºä¸»ä½“ */
        .machine-container {
            background: var(--machine-color);
            width: 90%;
            max-width: 400px;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            box-sizing: border-box;
            box-shadow: inset -10px 0 rgba(0,0,0,0.1), 0 10px 20px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
            border: 4px solid var(--machine-dark);
            border-bottom: none;
        }

        .machine-header {
            background: rgba(0,0,0,0.1);
            width: 100%;
            text-align: center;
            padding: 5px 0;
            border-radius: 10px;
            margin-bottom: 15px;
            color: white;
            font-size: 1.2rem;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.3);
        }

        /* å•†å“å±•ç¤ºçª— */
        .display-window {
            background: white;
            width: 100%;
            height: 180px;
            border-radius: 15px;
            border: 4px solid #B0BEC5;
            box-shadow: inset 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .product-display-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: opacity 0.3s;
        }

        .product-emoji {
            font-size: 80px;
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .price-tag {
            background: #FFC107;
            color: #3E2723;
            padding: 5px 15px;
            border-radius: 10px;
            font-size: 1.8rem;
            margin-top: 10px;
            border: 2px solid #FF6F00;
            box-shadow: 0 3px 0 #FF6F00;
        }

        /* æŠ•å¸åŒº */
        .control-area {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .coin-slot-panel {
            background: #CFD8DC;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #90A4AE;
            width: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .slot-hole {
            width: 10px;
            height: 40px;
            background: #37474F;
            border-radius: 5px;
            margin: 10px 0;
            box-shadow: inset 2px 2px 5px black;
            border: 2px solid #B0BEC5;
        }

        .slot-label {
            font-size: 0.9rem;
            color: #546E7A;
        }

        /* æ˜¾ç¤ºå± */
        .lcd-screen {
            flex: 1;
            background: var(--screen-bg);
            margin-left: 15px;
            height: 80px;
            border-radius: 5px;
            border: 4px solid #546E7A;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 5px;
            box-shadow: inset 0 0 10px black;
        }

        .lcd-label {
            color: #90A4AE;
            font-size: 0.8rem;
        }
        .lcd-value {
            color: var(--screen-text);
            font-family: "Courier New", monospace;
            font-size: 1.8rem;
            font-weight: bold;
            text-shadow: 0 0 5px var(--screen-text);
        }
        
        /* å‡ºè´§å£ */
        .pickup-slot {
            width: 80%;
            height: 60px;
            background: #333;
            border-radius: 0 0 10px 10px;
            margin-top: auto;
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: inset 0 5px 10px rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: visible;
        }
        
        .purchased-item {
            font-size: 50px;
            animation: dropOut 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
        }
        @keyframes dropOut {
            0% { transform: translateY(-50px) scale(0.5); opacity: 0; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }

        /* é’±åŒ…/æ“ä½œå° */
        .wallet-panel {
            background: #5D4037;
            width: 100%;
            padding: 15px 0 30px 0; 
            padding-bottom: env(safe-area-inset-bottom, 30px); /* é€‚é…å®‰å…¨åŒº */
            border-top: 5px solid #3E2723;
            display: flex;
            justify-content: center;
            gap: 20px;
            position: relative;
            z-index: 50;
            flex-shrink: 0;
        }
        
        .wallet-balance {
             position: absolute;
             top: -40px;
             left: 50%;
             transform: translateX(-50%);
             background: #8D6E63;
             color: #FFF;
             padding: 5px 20px;
             border-radius: 20px;
             border: 2px solid #D7CCC8;
             font-size: 1.2rem;
             box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .coin {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            cursor: grab;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3), inset 0 2px 5px rgba(255,255,255,0.5);
            position: relative;
            user-select: none;
            transition: transform 0.1s;
        }
        .coin:active { transform: scale(0.95); cursor: grabbing; }
        
        .coin.disabled {
            opacity: 0.5;
            filter: grayscale(1);
            cursor: not-allowed;
        }

        .coin-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #D32F2F;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            border: 2px solid white;
            box-shadow: 0 2px 2px rgba(0,0,0,0.2);
        }

        .coin-1yuan {
            background: var(--coin-1yuan);
            color: #78909C;
            border: 4px solid #CFD8DC;
        }
        .coin-5jiao {
            background: var(--coin-5jiao);
            color: #8D6E63;
            border: 4px solid #FBC02D;
        }
        .coin-1jiao {
            background: var(--coin-1jiao);
            color: #90A4AE;
            border: 4px solid #B0BEC5;
            width: 60px;
            height: 60px;
            font-size: 0.9rem;
        }

        .coin span { font-size: 1.2rem; pointer-events: none; }
        .coin small { font-size: 0.7rem; pointer-events: none; }

        /* åé¦ˆåŠ¨ç”» */
        .feedback-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .feedback-overlay.visible { opacity: 1; pointer-events: auto; }
        
        .feedback-box {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            transform: scale(0.8);
            transition: transform 0.3s;
        }
        .feedback-overlay.visible .feedback-box { transform: scale(1); }
        
        .feedback-emoji { font-size: 60px; display: block; margin-bottom: 10px; }
        .feedback-text { font-size: 1.5rem; color: #333; }
        
        /* å·²è´­å•†å“æ¸…å• */
        .inventory-bar {
            position: fixed;
            top: 60px;
            right: 10px;
            width: 60px;
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            padding: 10px 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .inventory-title { font-size: 0.8rem; color: #555; margin-bottom: 5px; }
        .inventory-item { font-size: 1.5rem; }

        /* æ‹–æ‹½æ—¶çš„æ ·å¼ */
        .dragging-coin {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            opacity: 0.9;
            transform: scale(1.1);
        }

        /* æŠ•å¸å£é«˜äº® */
        .slot-highlight {
            box-shadow: 0 0 15px #FFEB3B;
            border-color: #FFEB3B;
        }

    </style>
</head>
<body>

<a href="index.html" class="btn-home">ğŸ </a>

<header>
    <h1>ğŸª™ åŠ¨ç‰©å”®è´§æœº</h1>
    <div class="level-info" id="level-text">ç¬¬ 1 å…³</div>
</header>

<div class="inventory-bar" id="my-bag">
    <div class="inventory-title">æˆ‘çš„åŒ…åŒ…</div>
    <div id="bag-items"></div>
</div>

<div class="machine-container">
    <div class="machine-header">è¯·æŠ•å…¥æ­£ç¡®çš„é‡‘é¢è´­ä¹°å•†å“</div>
    
    <div class="display-window">
        <div class="product-display-area" id="product-area">
            <div class="product-emoji" id="target-emoji">ğŸ¦</div>
            <div class="price-tag" id="target-price">2å…ƒ 5è§’</div>
        </div>
    </div>
    
    <!-- å‡ºè´§å£ -->
    <div class="pickup-slot" id="pickup-slot"></div>

    <div class="control-area">
        <!-- æŠ•å¸å£ -->
        <div class="coin-slot-panel" id="drop-zone">
            <div class="slot-label">æŠ•å¸å£</div>
            <div class="slot-hole"></div>
            <div class="slot-label">INSERT COIN</div>
        </div>

        <!-- æ˜¾ç¤ºå± -->
        <div class="lcd-screen">
            <div class="lcd-label">å·²æŠ•é‡‘é¢</div>
            <div class="lcd-value" id="current-money">0å…ƒ 0è§’</div>
        </div>
    </div>
</div>

<div class="wallet-panel" id="wallet">
    <div class="wallet-balance" id="total-balance">é’±åŒ…: 20å…ƒ 0è§’</div>
    
    <!-- é’±å¸æº -->
    <div class="coin coin-1yuan" id="coin-10" data-val="10">
        <span>1</span><small>å…ƒ</small>
        <div class="coin-count" id="count-10">10</div>
    </div>
    <div class="coin coin-5jiao" id="coin-5" data-val="5">
        <span>5</span><small>è§’</small>
        <div class="coin-count" id="count-5">10</div>
    </div>
    <div class="coin coin-1jiao" id="coin-1" data-val="1">
        <span>1</span><small>è§’</small>
        <div class="coin-count" id="count-1">20</div>
    </div>
</div>

<div class="feedback-overlay" id="feedback-modal">
    <div class="feedback-box">
        <div class="feedback-emoji" id="fb-emoji">ğŸ‰</div>
        <div class="feedback-text" id="fb-text">è´­ä¹°æˆåŠŸï¼</div>
    </div>
</div>

<script>
    // ==========================================
    // ğŸ”Š éŸ³æ•ˆç®¡ç†
    // ==========================================
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    const Sounds = {
        click: () => {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.05);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.05);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.05);
        },
        insert: () => {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const t = audioCtx.currentTime;
            
            // ä¸»éŸ³ï¼šé«˜é¢‘é‡‘å±æ’å‡»
            const osc1 = audioCtx.createOscillator();
            const gain1 = audioCtx.createGain();
            osc1.type = 'sine';
            osc1.frequency.setValueAtTime(2000, t);
            osc1.frequency.exponentialRampToValueAtTime(1000, t + 0.1);
            gain1.gain.setValueAtTime(0.1, t);
            gain1.gain.exponentialRampToValueAtTime(0.01, t + 0.2);
            
            // è¾…éŸ³ï¼šäº§ç”Ÿé‡‘å±é¢¤éŸ³ (æ‹é¢‘)
            const osc2 = audioCtx.createOscillator();
            const gain2 = audioCtx.createGain();
            osc2.type = 'triangle';
            osc2.frequency.setValueAtTime(2200, t); // ç¨å¾®é”™å¼€é¢‘ç‡
            osc2.frequency.exponentialRampToValueAtTime(1200, t + 0.1);
            gain2.gain.setValueAtTime(0.05, t);
            gain2.gain.exponentialRampToValueAtTime(0.01, t + 0.15);

            osc1.connect(gain1);
            osc2.connect(gain2);
            gain1.connect(audioCtx.destination);
            gain2.connect(audioCtx.destination);
            
            osc1.start(t);
            osc1.stop(t + 0.2);
            osc2.start(t);
            osc2.stop(t + 0.2);
        },
        clunk: () => {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            // æ¨¡æ‹Ÿé‡ç‰©æ‰è½çš„ä½éŸ³
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.2);
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.2);
        },
        success: () => {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            // ç®€å•çš„èƒœåˆ©æ—‹å¾‹ C-E-G-C
            [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'triangle';
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime + i*0.15);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + i*0.15 + 0.2);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(audioCtx.currentTime + i*0.15);
                osc.stop(audioCtx.currentTime + i*0.15 + 0.2);
            });
        }
    };

    // ==========================================
    // æ•°æ®é…ç½®
    // ==========================================
    const PRODUCTS = [
        // ç®€å•æ•´5/æ•´10
        { icon: 'ğŸ¬', name: 'ç³–æœ', price: 5 }, 
        { icon: 'ğŸ­', name: 'æ£’æ£’ç³–', price: 15 },
        { icon: 'ğŸ«', name: 'å·§å…‹åŠ›', price: 20 },
        { icon: 'ğŸª', name: 'é¥¼å¹²', price: 25 },
        { icon: 'ğŸ¦', name: 'å†°æ·‡æ·‹', price: 30 },
        { icon: 'ğŸ©', name: 'ç”œç”œåœˆ', price: 35 },
        { icon: 'ğŸ§ƒ', name: 'æœæ±', price: 40 },
        { icon: 'ğŸ§¸', name: 'å°ç†Š', price: 50 },
        // æ–°å¢ï¼šæœ‰é›¶æœ‰æ•´
        { icon: 'âœï¸', name: 'é“…ç¬”', price: 8 }, // 8è§’
        { icon: 'ğŸ“', name: 'å°ºå­', price: 12 }, // 1å…ƒ2è§’
        { icon: 'âœ‚ï¸', name: 'å‰ªåˆ€', price: 36 }, // 3å…ƒ6è§’
        { icon: 'ğŸ““', name: 'ç¬”è®°æœ¬', price: 28 }, // 2å…ƒ8è§’
        { icon: 'ğŸ–Œï¸', name: 'ç”»ç¬”', price: 16 }, // 1å…ƒ6è§’
        { icon: 'ğŸš—', name: 'ç©å…·è½¦', price: 88 }, // 8å…ƒ8è§’
        { icon: 'ğŸ¨', name: 'é¢œæ–™', price: 65 }, // 6å…ƒ5è§’
        { icon: 'ğŸ§¢', name: 'å¸½å­', price: 42 }, // 4å…ƒ2è§’
    ];

    // æ¸¸æˆçŠ¶æ€
    let currentLevel = 1;
    let currentTarget = null;
    let currentInserted = 0; // å•ä½ï¼šè§’
    let currentCoinStack = []; // è®°å½•æœ¬å±€æŠ•å…¥çš„ç¡¬å¸å†å² (ä¸ºäº†æ­£ç¡®é€€æ¬¾)
    
    // é’±åŒ…åº“å­˜ (å•ä½ï¼šä¸ª)
    let walletStock = {
        10: 10, // 1å…ƒ
        5: 10,  // 5è§’
        1: 20   // 1è§’
    };

    // åˆå§‹åŒ–
    function initGame() {
        updateWalletUI();
        startLevel(currentLevel);
        initDrag();
    }

    function startLevel(level) {
        currentInserted = 0;
        currentCoinStack = []; // æ¸…ç©ºå †æ ˆ
        updateScreen();
        
        // æ¸…ç†å‡ºè´§å£
        document.getElementById('pickup-slot').innerHTML = '';
        // æ˜¾ç¤ºå•†å“å±•ç¤ºåŒº
        document.getElementById('product-area').style.opacity = '1';

        // å…³å¡é€»è¾‘
        let candidates = [];
        if (level <= 2) {
            // 1-2å…³ï¼šæ•´å…ƒ æˆ– 5è§’
            candidates = PRODUCTS.filter(p => p.price % 5 === 0);
        } else if (level <= 4) {
            // 3-4å…³ï¼šç¨å¾®å¤æ‚ï¼Œå¯ä»¥å¸¦å°é›¶å¤´ï¼Œä»·æ ¼è¾ƒä½
            candidates = PRODUCTS.filter(p => p.price <= 40);
        } else {
            // 5å…³+ï¼šå…¨éšæœº
            candidates = PRODUCTS;
        }
        
        // éšæœºé€‰ä¸€ä¸ª
        currentTarget = candidates[Math.floor(Math.random() * candidates.length)];
        
        // UI æ›´æ–°
        document.getElementById('level-text').innerText = `ç¬¬ ${level} å…³`;
        document.getElementById('target-emoji').innerText = currentTarget.icon;
        document.getElementById('target-price').innerText = formatPrice(currentTarget.price);
    }

    // æ ¼å¼åŒ–ä»·æ ¼ (è§’ -> å…ƒè§’)
    function formatPrice(jiao) {
        const y = Math.floor(jiao / 10);
        const j = jiao % 10;
        if (j === 0) return `${y}å…ƒ`;
        if (y === 0) return `${j}è§’`;
        return `${y}å…ƒ ${j}è§’`;
    }

    function updateWalletUI() {
        // æ›´æ–°ç¡¬å¸æ•°é‡
        document.getElementById('count-10').innerText = walletStock[10];
        document.getElementById('count-5').innerText = walletStock[5];
        document.getElementById('count-1').innerText = walletStock[1];

        // å˜ç°å¤„ç†
        document.getElementById('coin-10').classList.toggle('disabled', walletStock[10] <= 0);
        document.getElementById('coin-5').classList.toggle('disabled', walletStock[5] <= 0);
        document.getElementById('coin-1').classList.toggle('disabled', walletStock[1] <= 0);

        // æ›´æ–°æ€»ä½™é¢
        let totalVal = walletStock[10]*10 + walletStock[5]*5 + walletStock[1]*1;
        document.getElementById('total-balance').innerText = `é’±åŒ…: ${formatPrice(totalVal)}`;
    }

    function updateScreen() {
        const display = document.getElementById('current-money');
        display.innerText = currentInserted === 0 ? "0å…ƒ 0è§’" : formatPrice(currentInserted);
        
        // æ£€æŸ¥æ˜¯å¦è¾¾æˆç›®æ ‡
        if (currentTarget && currentInserted === currentTarget.price) {
            handleSuccess();
        } else if (currentTarget && currentInserted > currentTarget.price) {
            handleOverpaid(); 
        }
    }

    function handleSuccess() {
        // 1. å•†å“æ‰è½åŠ¨ç”»
        const pickupSlot = document.getElementById('pickup-slot');
        const item = document.createElement('div');
        item.className = 'purchased-item';
        item.innerText = currentTarget.icon;
        pickupSlot.appendChild(item);
        Sounds.clunk(); // éŸ³æ•ˆï¼šæ‰è½å£°
        
        // é’±è¢«æœºå™¨æ”¶èµ°äº†ï¼Œä¸éœ€è¦é€€å›ï¼Œæ¸…ç©ºå †æ ˆ
        currentCoinStack = [];
        
        // éšè—å±•ç¤ºåŒº
        document.getElementById('product-area').style.opacity = '0';
        
        // 2. æ”¾å…¥æˆ‘çš„åŒ…åŒ…
        addToBag(currentTarget.icon);
        
        // 3. æˆåŠŸåé¦ˆ
        setTimeout(() => {
            Sounds.success(); // éŸ³æ•ˆï¼šèƒœåˆ©éŸ³ä¹
            showFeedback(true, `ä¹°åˆ°äº†ï¼<br>${currentTarget.name}`);
            setTimeout(() => {
                currentLevel++;
                hideFeedback();
                // å»¶è¿Ÿä¸€ç‚¹å¼€å§‹ä¸‹ä¸€å…³ï¼Œè®©å­©å­çœ‹åˆ°ç©ºçš„å‡ºè´§å£
                setTimeout(() => startLevel(currentLevel), 500);
            }, 2000);
        }, 800); // ç­‰æ‰è½åŠ¨ç”»æ’­å®Œ
    }
    
    function addToBag(icon) {
        const bag = document.getElementById('bag-items');
        const div = document.createElement('div');
        div.className = 'inventory-item';
        div.innerText = icon;
        // æ–°ä¹°çš„æ”¾åœ¨æœ€ä¸Šé¢
        bag.prepend(div);
    }

    function handleOverpaid() {
        const screen = document.querySelector('.lcd-screen');
        screen.style.backgroundColor = '#B71C1C'; 
        setTimeout(() => {
            screen.style.backgroundColor = '';
            
            // é€€æ¬¾é€»è¾‘ï¼šåŸè·¯é€€å› (Stack)
            // æŠŠåˆšæ‰æŠ•è¿›å»çš„ç¡¬å¸åŸæ ·è¿˜ç»™é’±åŒ…
            currentCoinStack.forEach(val => {
                walletStock[val]++;
            });
            currentCoinStack = []; // æ¸…ç©ºå †æ ˆ
            
            updateWalletUI();

            currentInserted = 0;
            updateScreen();
            showFeedback(false, "ç»™å¤ªå¤šå•¦ï¼<br>é’±é€€å›æ¥å•¦ï¼Œå†è¯•ä¸€æ¬¡");
            setTimeout(hideFeedback, 1500);
        }, 500);
    }

    function showFeedback(isSuccess, html) {
        const modal = document.getElementById('feedback-modal');
        const emoji = document.getElementById('fb-emoji');
        const text = document.getElementById('fb-text');
        
        emoji.innerText = isSuccess ? currentTarget.icon : 'ğŸ˜«';
        text.innerHTML = html;
        modal.classList.add('visible');
    }

    function hideFeedback() {
        document.getElementById('feedback-modal').classList.remove('visible');
    }

    // ==========================================
    // æ‹–æ‹½äº¤äº’
    // ==========================================
    function initDrag() {
        const wallet = document.getElementById('wallet');
        const dropZone = document.getElementById('drop-zone');
        let dragEl = null;
        let isDragging = false;
        let coinValue = 0;

        function startDrag(e) {
            const target = e.target.closest('.coin');
            if (!target) return;
            
            // æ£€æŸ¥åº“å­˜
            const val = parseInt(target.dataset.val);
            if (walletStock[val] <= 0) return; // æ²¡æœ‰åº“å­˜äº†

            e.preventDefault();
            isDragging = true;
            Sounds.click(); // éŸ³æ•ˆï¼šæ‹¿èµ·ç¡¬å¸
            coinValue = val;
            
            const point = e.touches ? e.touches[0] : e;
            
            dragEl = target.cloneNode(true);
            const counter = dragEl.querySelector('.coin-count');
            if(counter) counter.remove();

            dragEl.className += ' dragging-coin';
            dragEl.style.left = (point.clientX - 35) + 'px';
            dragEl.style.top = (point.clientY - 35) + 'px';
            document.body.appendChild(dragEl);
            
            moveDrag(point);
        }

        function moveDrag(point) {
            if (!isDragging || !dragEl) return;
            dragEl.style.left = (point.clientX - 35) + 'px';
            dragEl.style.top = (point.clientY - 35) + 'px';

            const elemBelow = document.elementFromPoint(point.clientX, point.clientY);
            if (elemBelow && dropZone.contains(elemBelow)) {
                dropZone.classList.add('slot-highlight');
            } else {
                dropZone.classList.remove('slot-highlight');
            }
        }

        function endDrag(e) {
            if (!isDragging || !dragEl) return;
            
            const point = e.changedTouches ? e.changedTouches[0] : e;
            const elemBelow = document.elementFromPoint(point.clientX, point.clientY);
            
            if (elemBelow && dropZone.contains(elemBelow)) {
                // æŠ•å¸æˆåŠŸ
                playInsertAnimation();
                Sounds.insert(); // éŸ³æ•ˆï¼šç¡¬å¸å…¥å­”
                
                // æ‰£é™¤åº“å­˜
                walletStock[coinValue]--;
                updateWalletUI();

                // è®°å½•å†å²
                currentCoinStack.push(coinValue);

                // å¢åŠ å·²æŠ•é‡‘é¢
                currentInserted += coinValue;
                updateScreen();
            }

            document.body.removeChild(dragEl);
            dragEl = null;
            isDragging = false;
            dropZone.classList.remove('slot-highlight');
        }

        function playInsertAnimation() {
            const slot = document.querySelector('.slot-hole');
            slot.style.transform = 'scaleY(0.8)';
            setTimeout(() => slot.style.transform = 'scaleY(1)', 100);
        }

        wallet.addEventListener('mousedown', startDrag);
        wallet.addEventListener('touchstart', startDrag, {passive: false});
        
        window.addEventListener('mousemove', e => isDragging && moveDrag(e));
        window.addEventListener('touchmove', e => isDragging && moveDrag(e.touches[0]), {passive: false});
        
        window.addEventListener('mouseup', endDrag);
        window.addEventListener('touchend', endDrag);
    }

    // Start
    initGame();

</script>
</body>
</html>
